#!/usr/bin/env -S uv run --script
import re
import subprocess
import sys
from pathlib import Path


def find_init():
    candidates = [p for p in Path(".").rglob("__init__.py")
                  if "__version__" in p.read_text()]
    if not candidates:
        raise FileNotFoundError("no __init__.py with __version__ found")
    return min(candidates, key=lambda p: (len(p.parts), p))


def bump(version: str, part: str) -> str:
    major, minor, patch = map(int, version.split("."))
    match part:
        case "major": return f"{major + 1}.0.0"
        case "minor": return f"{major}.{minor + 1}.0"
        case "patch": return f"{major}.{minor}.{patch + 1}"
        case _: raise ValueError(f"unknown bump type: {part}")


def run(*cmd, check=True):
    print(f"$ {' '.join(cmd)}")
    subprocess.run(cmd, check=check)


def main():
    if len(sys.argv) != 2 or sys.argv[1] not in ("major", "minor", "patch"):
        sys.exit("usage: pydist <major|minor|patch>")

    part = sys.argv[1]
    init = find_init()
    text = init.read_text()

    match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', text)
    if not match:
        sys.exit(f"couldn't parse version in {init}")

    old, new = match.group(1), bump(match.group(1), part)
    print(f"{old} → {new}")

    init.write_text(text.replace(f'"{old}"', f'"{new}"').replace(f"'{old}'", f"'{new}'"))

    for dir in ("dist", "build"):
        if Path(dir).exists():
            run("rm", "-rf", dir)
    run("uv", "pip", "install", "build")
    run("uv", "run", "python", "-m", "build")

    try:
        run("uvx", "twine", "upload", "dist/*")
    except subprocess.CalledProcessError:
        print(f"\n✗ twine failed, reverting version bump")
        init.write_text(text)
        sys.exit(1)

    run("git", "commit", "-am", f"Release v{new}")
    run("git", "tag", f"v{new}")
    run("git", "push")
    run("git", "push", "--tags")

    print(f"\n✓ released v{new}")


if __name__ == "__main__":
    main()
